<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>Cesium å…¨éƒ¨æ•´åˆåœ¨ä¸€èµ·</title>
    <script src="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Cesium.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
    <style>
        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #controlPanel {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            width: 240px;
            font-size: 14px;
            max-height: 95vh;
            overflow-y: auto;
        }

        .accordion {
            background-color: #eee;
            color: #444;
            cursor: pointer;
            padding: 10px;
            width: 100%;
            border: none;
            text-align: left;
            outline: none;
            font-size: 16px;
            transition: 0.4s;
            border-radius: 3px;
            margin-top: 5px;
        }

        .accordion.active, .accordion:hover { background-color: #ccc; }
        .panel {
            padding: 5px;
            display: none;
            background-color: white;
            overflow: hidden;
        }
        .city-group {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .city-btn {
            flex: 1 1 45%;
            padding: 5px;
            background-color: #82a4c8;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        .city-btn:hover { background-color: #82a4c8; }

        /* è‡ªè¨‚åœ–ç¤ºç›¸é—œæ¨£å¼ */
        .icon-upload-section {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            background-color: #f9f9f9;
        }

        .icon-preview {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border: 2px solid #ddd;
            border-radius: 3px;
            margin: 5px;
        }

        .custom-icon-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
            background: white;
        }

        .custom-icon-item img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
            object-fit: cover;
        }

        .custom-icon-item .icon-info {
            flex: 1;
            font-size: 12px;
        }

        .custom-icon-item .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 2px 6px;
            cursor: pointer;
            font-size: 10px;
        }

        .scale-input {
            width: 60px;
            margin-left: 10px;
        }

        /* æ–°å¢æ¸…é™¤æŒ‰éˆ•æ¨£å¼ */
        .clear-building-btn {
            margin-top: 5px;
            width: 100%;
            background-color: #9a8fb4;
            color: #212529;
            border: none;
            padding: 5px;
            border-radius: 3px;
            cursor: pointer;
            font-weight: bold;
        }

        .clear-building-btn:hover {
            background-color: #aca2c2;
        }

        .clear-all-btn {
            margin-top: 10px;
            width: 100%;
            background-color: #b9535d;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .clear-all-btn:hover {
            background-color: #b9535d;
        }
    </style>
</head>
<body>
     <div id="cesiumContainer" style="width:100%; height:100%;"></div>

    <div id="controlPanel">
        <button class="accordion">3D å»ºç¯‰ç‰©åŒ¯å…¥</button>
        <div class="panel">
            <!-- ç¸£å¸‚é¸æ“‡ -->
            <button class="accordion">åŒ—éƒ¨</button>
            <div class="panel">
                <div class="city-group">
                    <button class="city-btn" data-city="taipei">å°åŒ—å¸‚</button>
                    <button class="city-btn" data-city="new_taipei">æ–°åŒ—å¸‚</button>
                    <button class="city-btn" data-city="keelung">åŸºéš†å¸‚</button>
                    <button class="city-btn" data-city="taoyuan">æ¡ƒåœ’å¸‚</button>
                    <button class="city-btn" data-city="hsinchu_city">æ–°ç«¹å¸‚</button>
                    <button class="city-btn" data-city="hsinchu_county">æ–°ç«¹ç¸£</button>
                    <button class="city-btn" data-city="yilan">å®œè˜­ç¸£</button>
                </div>
            </div>

            <button class="accordion">ä¸­éƒ¨</button>
            <div class="panel">
                <div class="city-group">
                    <button class="city-btn" data-city="miaoli">è‹—æ —ç¸£</button>
                    <button class="city-btn" data-city="taichung">å°ä¸­å¸‚</button>
                    <button class="city-btn" data-city="changhua">å½°åŒ–ç¸£</button>
                    <button class="city-btn" data-city="nantou">å—æŠ•ç¸£</button>
                    <button class="city-btn" data-city="yunlin">é›²æ—ç¸£</button>
                </div>
            </div>

            <button class="accordion">å—éƒ¨</button>
            <div class="panel">
                <div class="city-group">
                    <button class="city-btn" data-city="chiayi_city">å˜‰ç¾©å¸‚</button>
                    <button class="city-btn" data-city="chiayi_county">å˜‰ç¾©ç¸£</button>
                    <button class="city-btn" data-city="tainan">å°å—å¸‚</button>
                    <button class="city-btn" data-city="kaohsiung">é«˜é›„å¸‚</button>
                    <button class="city-btn" data-city="pingtung">å±æ±ç¸£</button>
                </div>
            </div>

            <button class="accordion">æ±éƒ¨</button>
            <div class="panel">
                <div class="city-group">
                    <button class="city-btn" data-city="taitung">å°æ±ç¸£</button>
                    <button class="city-btn" data-city="hualien">èŠ±è“®ç¸£</button>
                </div>
            </div>

            <button class="accordion">é›¢å³¶</button>
            <div class="panel">
                <div class="city-group">
                    <button class="city-btn" data-city="kinmen">é‡‘é–€ç¸£</button>
                    <button class="city-btn" data-city="penghu">æ¾æ¹–ç¸£</button>
                    <button class="city-btn" data-city="lienchiang">é€£æ±Ÿç¸£</button>
                </div>
            </div>

            <button id="locateBtn" style="margin-top:5px;width:100%;background-color:#7d92a9;color:white;border:none;padding:5px;border-radius:3px;cursor:pointer;">
                å®šä½ä¸¦è¼‰å…¥å»ºç¯‰ç‰©
            </button>

            <button id="clearBuildingsBtn" class="clear-building-btn">
                æ¸…é™¤åœ°åœ–å»ºç¯‰ç‰©
            </button>
        </div>

        <button class="accordion">è³‡æ–™é›†</button>
        <div class="panel">
            <label for="RepairFileInput">ä¸Šå‚³è³‡æ–™é›†</label>
            <input type="file" id="RepairFileInput" accept=".json,.geojson" style="width:100%;margin-bottom:5px;"/>
            
            <div id="iconChooser" style="margin-bottom:5px;">
                <strong>é¸æ“‡åœ–ç¤ºï¼š</strong>
                
                <!-- é è¨­åœ–ç¤º -->
                <div style="margin: 5px 0;">
                    <strong style="font-size: 12px;">é è¨­åœ–ç¤ºï¼š</strong>
                    <div id="defaultIcons" style="display:flex;gap:4px;margin-top:4px;"></div>
                </div>
                
                <!-- è‡ªè¨‚åœ–ç¤ºä¸Šå‚³ -->
                <div class="icon-upload-section">
                    <strong style="font-size: 12px;">è‡ªè¨‚åœ–ç¤ºï¼š</strong>
                    <div style="margin: 5px 0;">
                        <label for="iconFileInput" style="font-size: 11px;">ä¸Šå‚³ 2D åœ–ç¤º (PNG/JPG)ï¼š</label>
                        <input type="file" id="iconFileInput" accept=".png,.jpg,.jpeg" style="width:100%;font-size:11px;"/>
                    </div>
                    <div style="margin: 5px 0;">
                        <label for="modelFileInput" style="font-size: 11px;">ä¸Šå‚³ 3D æ¨¡å‹ (GLTF/GLB)ï¼š</label>
                        <input type="file" id="modelFileInput" accept=".gltf,.glb" style="width:100%;font-size:11px;"/>
                        <label style="font-size: 10px;">ç¸®æ”¾æ¯”ä¾‹ï¼š</label>
                        <input type="number" id="modelScale" class="scale-input" value="1.0" step="0.1" min="0.1" max="100"/>
                    </div>
                    <button id="uploadIconBtn" style="width:100%;background:#28a745;color:white;border:none;padding:5px;border-radius:3px;cursor:pointer;font-size:11px;">
                        æ·»åŠ è‡ªè¨‚åœ–ç¤º
                    </button>
                </div>
                
                <!-- è‡ªè¨‚åœ–ç¤ºæ¸…å–® -->
                <div id="customIconsList" style="margin: 5px 0;">
                    <strong style="font-size: 12px;">å·²ä¸Šå‚³åœ–ç¤ºï¼š</strong>
                    <div id="customIconsContainer"></div>
                </div>
            </div>
            
            <button id="confirmImportBtn" style="width:100%">ç¢ºèªåŒ¯å…¥</button>
            <div>
                <strong>å·²åŒ¯å…¥è³‡æ–™é›†ï¼š</strong>
                <ul id="datasetsList" style="padding-left:20px;"></ul>
            </div>
            <button id="flyToBtn" style="margin-top:5px;width:100%;background-color:#17a2b8;color:white;border:none;padding:5px;border-radius:3px;cursor:pointer;">
                é£›åˆ°è³‡æ–™ä½ç½®
            </button>
            <button id="clearBtn" style="margin-top:5px;width:100%;background-color:#dc3545;color:white;border:none;padding:5px;border-radius:3px;cursor:pointer;">
                æ¸…é™¤æ‰€æœ‰è³‡æ–™
            </button>
        </div>
        <!-- æ–°å¢ï¼šæ¸…é™¤å…¨éƒ¨æŒ‰éˆ•ï¼ˆèˆ‡3Då»ºç¯‰ç‰©åŒ¯å…¥ã€è³‡æ–™é›†åŒç´šï¼‰ -->
        <button id="clearAllBtn" class="clear-all-btn">
            ğŸ—‘ï¸ æ¸…é™¤å…¨éƒ¨å…§å®¹
        </button>
    </div>

    <script>
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNmIzMDE3Yy1mYWQ2LTQ4YTQtOWQ3Ny1lZjgwNTcxOTU5MTkiLCJpZCI6MzIyMjU0LCJpYXQiOjE3NTI3MjY4MjJ9.12vLgFNaTNa4AO8PYo3hByBcXUodMbnX_u--RM59ySg';

        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrain: Cesium.Terrain.fromWorldTerrain(),
            animation: false,
            baseLayerPicker: false,
            timeline: false,
            baseLayer: Cesium.ImageryLayer.fromProviderAsync(
            Cesium.ArcGisMapServerImageryProvider.fromUrl("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer")
        )
        });

        // é›»å­åœ°åœ–åœ–å±¤ (å…§æ”¿éƒ¨ WMTS)
        const emapWmtsLayer = viewer.imageryLayers.addImageryProvider(
            new Cesium.UrlTemplateImageryProvider({
                url: "https://wmts.nlsc.gov.tw/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}.png",
                tilingScheme: new Cesium.WebMercatorTilingScheme(),
                maximumLevel: 18
            })
        );
        emapWmtsLayer.show = true;

        // åˆå§‹ç›¸æ©Ÿä½ç½®ï¼šå°ç£
        viewer.scene.postRender.addEventListener(function once() {
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 350000),
            orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch: Cesium.Math.toRadians(-90),
            roll: 0
            }
        });
        viewer.scene.postRender.removeEventListener(once);
        });

        // ç¸£å¸‚å°æ‡‰çš„ 3D Tiles è·¯å¾‘èˆ‡å®šä½è³‡è¨Š
        const tilesetConfigs = {
            taipei: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/0/tileset.json', lon: 121.5654, lat: 25.0330, height: 50 },
            taichung: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/1/tileset.json', lon: 120.6839, lat: 24.1371, height: 50 },
            keelung: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/2/tileset.json', lon: 121.7445, lat: 25.1276, height: 50 },
            tainan: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/3/tileset.json', lon: 120.2270, lat: 22.9999, height: 50 },
            kaohsiung: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/4/tileset.json', lon: 120.6660, lat: 22.6273, height: 50 },
            new_taipei: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/5/tileset.json', lon: 121.6739, lat: 24.9157, height: 50 },
            yilan: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/6/tileset.json', lon: 121.7195, lat: 24.7021, height: 50 },
            taoyuan: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/7/tileset.json', lon: 121.2168, lat: 24.9372, height: 50 },
            chiayi_city: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/8/tileset.json', lon: 120.4473, lat: 23.4755, height: 50 },
            hsinchu_county: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/9/tileset.json', lon: 121.0182, lat: 24.8387, height: 50 },
            miaoli: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/10/tileset.json', lon: 120.9417, lat: 24.4892, height: 50 },
            nantou: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/11/tileset.json', lon: 120.9876, lat: 23.8388, height: 50 },
            changhua: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/12/tileset.json', lon: 120.4818, lat: 24.0518, height: 50 },
            hsinchu_city: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/13/tileset.json', lon: 120.9686, lat: 24.8039, height: 50 },
            yunlin: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/14/tileset.json', lon: 120.3897, lat: 23.7559, height: 50 },
            chiayi_county: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/15/tileset.json', lon: 120.2550, lat: 23.4518, height: 50 },
            pingtung: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/16/tileset.json', lon: 120.5487, lat: 22.5519, height: 50 },
            hualien: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/17/tileset.json', lon: 121.3542, lat: 23.7569, height: 50 },
            taitung: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/18/tileset.json', lon: 121.1132, lat: 22.7610, height: 50 },
            kinmen: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/19/tileset.json', lon: 118.3171, lat: 24.4321, height: 50 },
            penghu: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/20/tileset.json', lon: 119.6151, lat: 23.5655, height: 50 },
            lienchiang: { url: 'https://3dtiles.nlsc.gov.tw/building/tiles3d/21/tileset.json', lon: 119.9510, lat: 26.1608, height: 50 }
        };

        const loadedTilesets = [];
        let currentTileset = null;
        let userPoint = null;

        // æ‰‹é¢¨ç´é¸å–®å±•é–‹æ”¶åˆ
        document.querySelectorAll(".accordion").forEach(acc => {
            acc.addEventListener("click", function () {
                const siblingAccordions = Array.from(this.parentElement.children)
                    .filter(el => el.classList && el.classList.contains("accordion") && el !== this);
                const siblingPanels = siblingAccordions.map(acc => acc.nextElementSibling);

                siblingAccordions.forEach(btn => btn.classList.remove("active"));
                siblingPanels.forEach(panel => panel.style.display = "none");

                this.classList.toggle("active");
                const panel = this.nextElementSibling;
                panel.style.display = (panel.style.display === "block") ? "none" : "block";
            });
        });

        document.getElementById("locateBtn").addEventListener("click", () => {
            if (!("geolocation" in navigator)) {
                alert("æ­¤ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                return;
            }
            navigator.geolocation.getCurrentPosition(async (position) => {
                const lon = position.coords.longitude;
                const lat = position.coords.latitude;
                const height = 800;
                const center = Cesium.Cartesian3.fromDegrees(lon, lat, height);

                function getNearestCity(lon, lat) {
                    let nearest = null;
                    let minDistance = Number.MAX_VALUE;
                    for (const key in tilesetConfigs) {
                        const city = tilesetConfigs[key];
                        const dist = Math.sqrt(
                            Math.pow(city.lon - lon, 2) +
                            Math.pow(city.lat - lat, 2)
                        );
                        if (dist < minDistance) {
                            minDistance = dist;
                            nearest = key;
                        }
                    }
                    return nearest;
                }

                const cityKey = getNearestCity(lon, lat);
                const config = tilesetConfigs[cityKey];

                if (currentTileset) viewer.scene.primitives.remove(currentTileset);
                const tileset = await Cesium.Cesium3DTileset.fromUrl(config.url);
                currentTileset = tileset;
                viewer.scene.primitives.add(tileset);

                viewer.camera.flyTo({
                    destination: center,
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-90.0),
                        roll: 0.0
                    }
                });

                if (userPoint) viewer.entities.remove(userPoint);
                    userPoint = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(lon, lat),
                        billboard: {
                            image: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                            width: 32,
                            height: 32,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        }
                    });

                let lastHeight = null;
                viewer.scene.camera.changed.addEventListener(() => {
                    if (!userPoint) return;
                    if (userPoint.billboard) {
                        const cameraHeight = viewer.scene.camera.positionCartographic.height;
                        let newSize = Math.max(8, Math.min(48, 350000 / cameraHeight));
                        userPoint.billboard.width = newSize;
                        userPoint.billboard.height = newSize;
                    }
                });

                console.log("è¼‰å…¥çš„ç¸£å¸‚ tileset:", cityKey);
            });
        });

        // æ–°å¢ï¼šæ¸…é™¤å»ºç¯‰ç‰©åŠŸèƒ½
        document.getElementById("clearBuildingsBtn").addEventListener("click", function() {
            if (confirm("ç¢ºå®šè¦æ¸…é™¤åœ°åœ–ä¸Šçš„æ‰€æœ‰å»ºç¯‰ç‰©å—ï¼Ÿ")) {
                // æ¸…é™¤ç•¶å‰ tileset
                if (currentTileset) {
                    viewer.scene.primitives.remove(currentTileset);
                    const index = loadedTilesets.indexOf(currentTileset);
                    if (index > -1) {
                        loadedTilesets.splice(index, 1);
                    }
                    currentTileset = null;
                }
                
                // æ¸…é™¤æ‰€æœ‰å·²è¼‰å…¥çš„ tilesets
                loadedTilesets.forEach(tileset => {
                    viewer.scene.primitives.remove(tileset);
                });
                loadedTilesets.length = 0;
                
                // æ¸…é™¤å®šä½æ¨™è¨˜
                if (userPoint) {
                    viewer.entities.remove(userPoint);
                    userPoint = null;
                }
                
                alert("å·²æ¸…é™¤åœ°åœ–ä¸Šçš„æ‰€æœ‰å»ºç¯‰ç‰©ï¼");
            }
        });

        // ç¸£å¸‚é¸å–®äº‹ä»¶
        document.querySelectorAll('.city-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
            const selected = this.dataset.city;

            if (currentTileset) {
                viewer.scene.primitives.remove(currentTileset);
                const index = loadedTilesets.indexOf(currentTileset);
                if (index > -1) loadedTilesets.splice(index, 1);
                currentTileset = null;
            }

            if (!selected || !tilesetConfigs[selected]) return;

            const config = tilesetConfigs[selected];

            try {
                const tileset = await Cesium.Cesium3DTileset.fromUrl(config.url);
                currentTileset = tileset;
                viewer.scene.primitives.add(tileset);
                loadedTilesets.push(tileset);

                const position = Cesium.Cartesian3.fromDegrees(config.lon, config.lat, config.height);

                viewer.zoomTo(tileset).then(() => {
                const center = Cesium.Cartesian3.fromDegrees(config.lon, config.lat, config.height + 5000);
                viewer.camera.flyTo({
                    destination: center,
                    orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-90),
                    roll: 0
                },
                duration: 2.5
                });
            });
            } catch (error) {
                alert("è¼‰å…¥å¤±æ•—ï¼š" + error.message);
                console.error(error);
            }
            });
        });

        // ç‹€æ…‹è®Šæ•¸
        let pendingGeojson = null, pendingName = '';
        let datasets = {}; // å„²å­˜å¤šçµ„è³‡æ–™
        let currentDataSource = null;
        let selectedIconType = "", selectedIconValue = "", selectedIconScale = 1.0;

        // é è¨­åœ–ç¤ºé¸é …
        const defaultIconOptions = [
            {
                type: "image",
                label: "è­¦ç¤ºé»",
                img: "https://cdn-icons-png.flaticon.com/512/3756/3756712.png",
                value: "https://cdn-icons-png.flaticon.com/512/3756/3756712.png"
            },
            {
                type: "image",
                label: "åœ°é»æ¨™è¨˜",
                img: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
                value: "https://cdn-icons-png.flaticon.com/512/684/684908.png"
            },
            {
                type: "model",
                label: "3Däººå­”è“‹",
                img: "./manhole_3dmodel/manhole.jpg",
                value: "./manhole_3dmodel/manhole.gltf",
                scale: 0.02 // èª¿æ•´æ¨¡å‹å€ç‡
            },
            {
                type: "model",
                label: "3Dè·¯ç‡ˆ",
                img: "./streetlamp_3dmodel/images.jpg",
                value: "./streetlamp_3dmodel/streetlamp.gltf",
                scale: 2 // èª¿æ•´æ¨¡å‹å€ç‡
                // img: "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Lantern/glTF/Lantern.png",
                // value: "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Lantern/glTF/Lantern.gltf"
            }
        ];

        // è‡ªè¨‚åœ–ç¤ºå„²å­˜
        let customIconOptions = [];

        // å»ºç«‹é è¨­åœ–ç¤ºé¸æ“‡å™¨
        function buildDefaultIconChooser() {
            const container = document.getElementById("defaultIcons");
            container.innerHTML = "";
            defaultIconOptions.forEach((opt, idx) => {
                const img = document.createElement("img");
                img.src = opt.img;
                img.width = 32;
                img.height = 32;
                img.className = "icon-option";
                img.dataset.type = opt.type;
                img.dataset.value = opt.value;
                img.dataset.scale = "1.0";
                img.title = opt.label;
                img.style.cursor = "pointer";
                img.style.border = idx === 0 ? "2px solid #007BFF" : "2px solid transparent";
                img.onclick = function() {
                    document.querySelectorAll(".icon-option, .custom-icon-option").forEach(i => i.style.border = "2px solid transparent");
                    img.style.border = "2px solid #007BFF";
                    selectedIconType = opt.type;
                    selectedIconValue = opt.value;
                    selectedIconScale = 1.0;
                };
                container.appendChild(img);
            });
            
            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹
            if (defaultIconOptions.length > 0) {
                selectedIconType = defaultIconOptions[0].type;
                selectedIconValue = defaultIconOptions[0].value;
                selectedIconScale = 1.0;
            }
        }

        // å»ºç«‹è‡ªè¨‚åœ–ç¤ºæ¸…å–®
        function buildCustomIconsList() {
            const container = document.getElementById("customIconsContainer");
            container.innerHTML = "";
            
            customIconOptions.forEach((opt, idx) => {
                const item = document.createElement("div");
                item.className = "custom-icon-item";
                
                const img = document.createElement("img");
                img.src = opt.img;
                img.className = "custom-icon-option";
                img.dataset.type = opt.type;
                img.dataset.value = opt.value;
                img.dataset.scale = opt.scale || "1.0";
                img.title = opt.label;
                img.style.cursor = "pointer";
                img.style.border = "2px solid transparent";
                img.onclick = function() {
                    document.querySelectorAll(".icon-option, .custom-icon-option").forEach(i => i.style.border = "2px solid transparent");
                    img.style.border = "2px solid #007BFF";
                    selectedIconType = opt.type;
                    selectedIconValue = opt.value;
                    selectedIconScale = parseFloat(opt.scale || "1.0");
                };
                
                const info = document.createElement("div");
                info.className = "icon-info";
                info.innerHTML = `
                    <div>${opt.label}</div>
                    <div style="color: #666;">${opt.type === 'model' ? '3Dæ¨¡å‹' : '2Dåœ–ç¤º'}${opt.type === 'model' ? ' (æ¯”ä¾‹: ' + opt.scale + ')' : ''}</div>
                `;
                
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "delete-btn";
                deleteBtn.textContent = "åˆªé™¤";
                deleteBtn.onclick = function(e) {
                    e.stopPropagation();
                    customIconOptions.splice(idx, 1);
                    buildCustomIconsList();
                    // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„åœ–ç¤ºï¼Œé‡ç½®ç‚ºé è¨­
                    if (selectedIconValue === opt.value) {
                        if (defaultIconOptions.length > 0) {
                            selectedIconType = defaultIconOptions[0].type;
                            selectedIconValue = defaultIconOptions[0].value;
                            selectedIconScale = 1.0;
                            buildDefaultIconChooser();
                        }
                    }
                };
                
                item.appendChild(img);
                item.appendChild(info);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });
        }

        // åˆå§‹åŒ–åœ–ç¤ºé¸æ“‡å™¨
        buildDefaultIconChooser();
        buildCustomIconsList();

        // è‡ªè¨‚åœ–ç¤ºä¸Šå‚³è™•ç†
        document.getElementById("uploadIconBtn").addEventListener("click", function() {
            const iconFile = document.getElementById("iconFileInput").files[0];
            const modelFile = document.getElementById("modelFileInput").files[0];
            const scale = parseFloat(document.getElementById("modelScale").value) || 1.0;

            if (!iconFile && !modelFile) {
                alert("è«‹é¸æ“‡è¦ä¸Šå‚³çš„åœ–ç¤ºæˆ–æ¨¡å‹æª”æ¡ˆï¼");
                return;
            }

            if (iconFile && modelFile) {
                alert("è«‹ä¸€æ¬¡åªä¸Šå‚³ä¸€ç¨®é¡å‹çš„æª”æ¡ˆï¼");
                return;
            }

            if (iconFile) {
                // è™•ç† 2D åœ–ç¤º
                const reader = new FileReader();
                reader.onload = function(e) {
                    const customIcon = {
                        type: "image",
                        label: iconFile.name.replace(/\.[^/.]+$/, ""),
                        img: e.target.result,
                        value: e.target.result,
                        scale: 1.0
                    };
                    customIconOptions.push(customIcon);
                    buildCustomIconsList();
                    alert(`2D åœ–ç¤º "${customIcon.label}" å·²æ·»åŠ ï¼`);
                    
                    // æ¸…ç©ºè¼¸å…¥
                    document.getElementById("iconFileInput").value = '';
                };
                reader.readAsDataURL(iconFile);
            }

            if (modelFile) {
                // è™•ç† 3D æ¨¡å‹
                const reader = new FileReader();
                reader.onload = function(e) {
                    // å‰µå»º Blob URL ç”¨æ–¼ 3D æ¨¡å‹
                    const blob = new Blob([e.target.result], {
                        type: modelFile.type || 'application/octet-stream'
                    });
                    const modelUrl = URL.createObjectURL(blob);
                    
                    // ä½¿ç”¨é è¨­åœ–ç¤ºä½œç‚º 3D æ¨¡å‹çš„ç¸®åœ–
                    const customIcon = {
                        type: "model",
                        label: modelFile.name.replace(/\.[^/.]+$/, ""),
                        img: "https://cdn-icons-png.flaticon.com/512/2103/2103633.png", // 3D æ¨¡å‹åœ–ç¤º
                        value: modelUrl,
                        scale: scale,
                        fileName: modelFile.name
                    };
                    customIconOptions.push(customIcon);
                    buildCustomIconsList();
                    alert(`3D æ¨¡å‹ "${customIcon.label}" å·²æ·»åŠ ï¼ç¸®æ”¾æ¯”ä¾‹: ${scale}`);
                    
                    // æ¸…ç©ºè¼¸å…¥
                    document.getElementById("modelFileInput").value = '';
                    document.getElementById("modelScale").value = '1.0';
                };
                reader.readAsArrayBuffer(modelFile);
            }
        });

        // æª”æ¡ˆä¸Šå‚³è®€å–
        document.getElementById("RepairFileInput").addEventListener("change", function(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    pendingGeojson = JSON.parse(e.target.result);
                    pendingName = file.name.replace(/\.[^/.]+$/, "");
                    alert('æª”æ¡ˆ "' + pendingName + '" å·²æš«å­˜ï¼Œå¯é¸åœ–ç¤ºå¾Œé»ç¢ºèªåŒ¯å…¥ã€‚');
                } catch {
                    alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
                    pendingGeojson = null;
                    pendingName = '';
                }
            };
            reader.readAsText(file);
        });

        // ç¢ºèªåŒ¯å…¥
        document.getElementById("confirmImportBtn").onclick = async function() {
            if (!pendingGeojson) { 
                alert("è«‹å…ˆä¸Šå‚³è³‡æ–™é›†ï¼"); 
                return; 
            }
            if (!selectedIconValue) { 
                alert("è«‹å…ˆé¸æ“‡åœ–ç¤ºï¼"); 
                return; 
            }
            
            const dsId = `ds_${Date.now()}`;
            try {
                const dataSource = await Cesium.GeoJsonDataSource.load(pendingGeojson, { 
                    clampToGround: true 
                });
                
                dataSource.entities.values.forEach(entity => {
                    if (selectedIconType === "image") {
                        entity.model = undefined;
                        entity.billboard = new Cesium.BillboardGraphics({
                            image: selectedIconValue,
                            width: 32,
                            height: 32,
                            verticalOrigin: Cesium.VerticalOrigin.CENTER,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        });
                    } else if (selectedIconType === "model") {
                        entity.billboard = undefined;
                        entity.model = new Cesium.ModelGraphics({
                            uri: selectedIconValue,
                            scale: selectedIconScale,
                            minimumPixelSize: 1,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                            runAnimations: false
                        });
                    }
                });
                
                // æ‰¾åˆ°å°æ‡‰çš„åœ–ç¤ºè³‡è¨Šï¼ˆç”¨æ–¼å„²å­˜ï¼‰
                let iconInfo = defaultIconOptions.find(opt => opt.value === selectedIconValue);
                if (!iconInfo) {
                    iconInfo = customIconOptions.find(opt => opt.value === selectedIconValue);
                }
                
                datasets[dsId] = {
                    id: dsId,
                    name: pendingName,
                    data: pendingGeojson,
                    iconType: selectedIconType,
                    iconValue: selectedIconValue,
                    iconScale: selectedIconScale,
                    iconInfo: iconInfo, // å„²å­˜å®Œæ•´åœ–ç¤ºè³‡è¨Š
                    dataSource: dataSource
                };
                
                updateDatasetsList();
                alert('è³‡æ–™é›† "' + pendingName + '" å·²åŒ¯å…¥ï¼Œå¯é»é¸é¡¯ç¤ºï¼');
                pendingGeojson = null; 
                pendingName = '';
                document.getElementById("RepairFileInput").value = '';
            } catch(e) {
                alert('GeoJSON è¼‰å…¥å¤±æ•—: ' + e.message);
                console.error(e);
            }
        };

        // æ›´æ–°è³‡æ–™é›†æ¸…å–®
        function updateDatasetsList() {
            const list = document.getElementById("datasetsList");
            list.innerHTML = '';
            for(const id in datasets) {
                const dataset = datasets[id];
                const li = document.createElement('li');
                
                // å‰µå»ºè³‡æ–™é›†é …ç›®ï¼ŒåŒ…å«åœ–ç¤ºé è¦½
                const itemDiv = document.createElement('div');
                itemDiv.style.display = 'flex';
                itemDiv.style.alignItems = 'center';
                itemDiv.style.marginBottom = '5px';
                itemDiv.style.cursor = 'pointer';
                itemDiv.onclick = () => showDataset(id);
                
                // åœ–ç¤ºé è¦½
                const iconPreview = document.createElement('img');
                if (dataset.iconInfo && dataset.iconInfo.img) {
                    iconPreview.src = dataset.iconInfo.img;
                } else {
                    // å‚™ç”¨åœ–ç¤º
                    iconPreview.src = dataset.iconType === 'model' 
                        ? "https://cdn-icons-png.flaticon.com/512/2103/2103633.png"
                        : "https://cdn-icons-png.flaticon.com/512/684/684908.png";
                }
                iconPreview.width = 20;
                iconPreview.height = 20;
                iconPreview.style.marginRight = '8px';
                iconPreview.style.objectFit = 'cover';
                
                // è³‡æ–™é›†åç¨±å’Œè³‡è¨Š
                const textDiv = document.createElement('div');
                textDiv.style.flex = '1';
                textDiv.innerHTML = `
                    <div style="font-weight: bold; font-size: 12px;">${dataset.name}</div>
                    <div style="font-size: 10px; color: #666;">
                        ${dataset.iconType === 'model' ? '3Dæ¨¡å‹' : '2Dåœ–ç¤º'}
                        ${dataset.iconType === 'model' ? ` (æ¯”ä¾‹: ${dataset.iconScale})` : ''}
                    </div>
                `;
                
                // åˆªé™¤æŒ‰éˆ•
                const delBtn = document.createElement('button');
                delBtn.textContent = 'åˆªé™¤';
                delBtn.style.marginLeft = '10px';
                delBtn.style.fontSize = '10px';
                delBtn.style.padding = '2px 6px';
                delBtn.style.background = '#dc3545';
                delBtn.style.color = 'white';
                delBtn.style.border = 'none';
                delBtn.style.borderRadius = '3px';
                delBtn.style.cursor = 'pointer';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    removeDataset(id);
                };
                
                itemDiv.appendChild(iconPreview);
                itemDiv.appendChild(textDiv);
                itemDiv.appendChild(delBtn);
                li.appendChild(itemDiv);
                list.appendChild(li);
            }
        }

        // é¡¯ç¤ºè³‡æ–™é›†ï¼ˆèšç„¦ï¼‰
        function showDataset(id) {
            if (currentDataSource) {
                viewer.dataSources.remove(currentDataSource);
            }
            currentDataSource = datasets[id].dataSource;
            viewer.dataSources.add(currentDataSource);
            
            // æ”¹ç”¨ Cesium å®˜æ–¹æ¨è–¦çš„ flyTo
            viewer.flyTo(currentDataSource, {
                duration: 2,
                offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90), 5000)
            });
        }

        // åˆªé™¤è³‡æ–™
        function removeDataset(id) {
            if (datasets[id]) {
                if (datasets[id].dataSource === currentDataSource) {
                    viewer.dataSources.remove(currentDataSource);
                    currentDataSource = null;
                }
                
                // å¦‚æœæ˜¯è‡ªè¨‚æ¨¡å‹ï¼Œé‡‹æ”¾ Blob URL
                if (datasets[id].iconType === 'model' && datasets[id].iconValue.startsWith('blob:')) {
                    URL.revokeObjectURL(datasets[id].iconValue);
                }
                
                delete datasets[id];
                updateDatasetsList();
            }
        }

        document.getElementById('clearBtn').onclick = function() {
            if (confirm('ç¢ºå®šæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿé€™å°‡åŒæ™‚æ¸…é™¤è‡ªè¨‚åœ–ç¤ºã€‚')) {
                // æ¸…é™¤æ‰€æœ‰è³‡æ–™é›†
                Object.values(datasets).forEach(ds => {
                    viewer.dataSources.remove(ds.dataSource);
                    // é‡‹æ”¾è‡ªè¨‚æ¨¡å‹çš„ Blob URL
                    if (ds.iconType === 'model' && ds.iconValue.startsWith('blob:')) {
                        URL.revokeObjectURL(ds.iconValue);
                    }
                });
                datasets = {};
                
                // æ¸…é™¤è‡ªè¨‚åœ–ç¤º
                customIconOptions.forEach(opt => {
                    if (opt.type === 'model' && opt.value.startsWith('blob:')) {
                        URL.revokeObjectURL(opt.value);
                    }
                });
                customIconOptions = [];
                
                pendingGeojson = null; 
                pendingName = '';
                updateDatasetsList();
                buildCustomIconsList();
                buildDefaultIconChooser(); // é‡ç½®é è¨­é¸æ“‡
            }
        };

        // é£›åˆ°ç›®å‰è³‡æ–™é›†
        document.getElementById("flyToBtn").onclick = function() {
            if (currentDataSource) {
                viewer.flyTo(currentDataSource, {
                    duration: 2,
                    offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90), 5000)
                });
            } else {
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 300000),
                    orientation: {
                        heading: Cesium.Math.toRadians(0),
                        pitch: Cesium.Math.toRadians(-90),
                        roll: 0
                    }
                });
            }
        };

        // æ–°å¢ï¼šæ¸…é™¤å…¨éƒ¨åŠŸèƒ½ï¼ˆåŒ…å«å»ºç¯‰ç‰©å’Œè³‡æ–™é›†ï¼‰
        document.getElementById("clearAllBtn").addEventListener("click", function() {
            if (confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤å…¨éƒ¨å…§å®¹å—ï¼Ÿ\n\né€™å°‡æ¸…é™¤ï¼š\nâ€¢ åœ°åœ–ä¸Šçš„æ‰€æœ‰å»ºç¯‰ç‰©\nâ€¢ æ‰€æœ‰å·²åŒ¯å…¥çš„è³‡æ–™é›†\nâ€¢ æ‰€æœ‰è‡ªè¨‚åœ–ç¤º\nâ€¢ å®šä½æ¨™è¨˜\n\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼")) {
                
                // 1. æ¸…é™¤å»ºç¯‰ç‰©
                if (currentTileset) {
                    viewer.scene.primitives.remove(currentTileset);
                    currentTileset = null;
                }
                loadedTilesets.forEach(tileset => {
                    viewer.scene.primitives.remove(tileset);
                });
                loadedTilesets.length = 0;
                
                // 2. æ¸…é™¤å®šä½æ¨™è¨˜
                if (userPoint) {
                    viewer.entities.remove(userPoint);
                    userPoint = null;
                }
                
                // 3. æ¸…é™¤æ‰€æœ‰è³‡æ–™é›†
                Object.values(datasets).forEach(ds => {
                    viewer.dataSources.remove(ds.dataSource);
                    // é‡‹æ”¾è‡ªè¨‚æ¨¡å‹çš„ Blob URL
                    if (ds.iconType === 'model' && ds.iconValue.startsWith('blob:')) {
                        URL.revokeObjectURL(ds.iconValue);
                    }
                });
                datasets = {};
                currentDataSource = null;
                
                // 4. æ¸…é™¤è‡ªè¨‚åœ–ç¤º
                customIconOptions.forEach(opt => {
                    if (opt.type === 'model' && opt.value.startsWith('blob:')) {
                        URL.revokeObjectURL(opt.value);
                    }
                });
                customIconOptions = [];
                
                // 5. é‡ç½®å¾…è™•ç†è³‡æ–™
                pendingGeojson = null; 
                pendingName = '';
                document.getElementById("RepairFileInput").value = '';
                
                // 6. æ›´æ–° UI
                updateDatasetsList();
                buildCustomIconsList();
                buildDefaultIconChooser();
                
                // 7. ç›¸æ©Ÿå›åˆ°å°ç£ä¿¯è¦–åœ–
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 350000),
                    orientation: {
                        heading: Cesium.Math.toRadians(0),
                        pitch: Cesium.Math.toRadians(-90),
                        roll: 0
                    }
                });
                
                alert("å·²æ¸…é™¤å…¨éƒ¨å…§å®¹ï¼åœ°åœ–å·²é‡ç½®ã€‚");
            }
        });

        // é»æ“Šé¡¯ç¤ºæè¿°
        viewer.cesiumWidget.screenSpaceEventHandler.setInputAction(function (click) {
            const picked = viewer.scene.pick(click.position);
            if (Cesium.defined(picked) && picked.id) {
                const entity = picked.id;
                if (entity.description) {
                    viewer.selectedEntity = entity;
                }
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // æ»‘é¼ ç§»å‹•é¡¯ç¤ºlabel
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction((movement) => {
            let picked = viewer.scene.pick(movement.endPosition);
            Object.values(datasets).forEach(ds => {
                ds.dataSource.entities.values.forEach((entity) => {
                    if (entity.label) {
                        entity.label.show = (picked && picked.id === entity);
                    }
                });
            });
        }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

        // Home éµè‡ªè¨‚
        viewer.homeButton.viewModel.command.beforeExecute.addEventListener(e => {
            e.cancel = true;
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 300000),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-90),
                    roll: 0
                }
            });
        });
    </script>
</body>
</html>