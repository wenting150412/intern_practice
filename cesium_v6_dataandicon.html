<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Cesium 載入資料及3D Icon</title>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden;}
    #controlPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      width: 220px;
      font-size: 14px;
    }
    .icon-option { cursor: pointer; border: 2px solid transparent; }
    .icon-option.selected { border-color: #007BFF; }
    button { cursor: pointer; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div id="controlPanel">
    <label for="fileInput">上傳資料集</label>
    <input type="file" id="fileInput" accept=".json,.geojson" style="width:100%;margin-bottom:5px;"/>

    <strong>選擇圖示：</strong>
    <div id="iconChooser" style="display:flex;gap:4px;margin:5px 0;"></div>

    <button id="importBtn" style="width:100%;margin-bottom:5px;">確認匯入</button>
    <button id="clearAllBtn" style="width:100%;background:#dc3545;color:#fff;">清除所有資料</button>
    
    <div style="margin-top:10px;">
      <strong>已匯入資料集：</strong>
      <ul id="datasetsList" style="padding-left:20px;"></ul>
    </div>
  </div>

  <script>
    Cesium.Ion.defaultAccessToken = 'YOUR_ACCESS_TOKEN';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false,
      baseLayerPicker: false,
      timeline: false,
      baseLayer: Cesium.ImageryLayer.fromProviderAsync(
        Cesium.ArcGisMapServerImageryProvider.fromUrl("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer")
      )
    });
    viewer.scene.globe.depthTestAgainstTerrain = true;

    // 初始相機位置
    viewer.scene.postRender.addEventListener(function once() {
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 350000),
        orientation: { heading: 0, pitch: Cesium.Math.toRadians(-90), roll: 0 }
      });
      viewer.scene.postRender.removeEventListener(once);
    });

    // 電子地圖 WMTS
    viewer.imageryLayers.addImageryProvider(new Cesium.UrlTemplateImageryProvider({
      url: "https://wmts.nlsc.gov.tw/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}.png",
      tilingScheme: new Cesium.WebMercatorTilingScheme(),
      maximumLevel: 18
    }));

    // 狀態變數
    let pendingGeojson = null, pendingName = '';
    let datasets = {};
    let currentDataSource = null;
    let selectedIcon = {};

    // 圖示選項
    const iconOptions = [
      { type: "image", label: "警示點", img: "https://cdn-icons-png.flaticon.com/512/3756/3756712.png", value: "https://cdn-icons-png.flaticon.com/512/3756/3756712.png" },
      { type: "image", label: "地點標記", img: "https://cdn-icons-png.flaticon.com/512/684/684908.png", value: "https://cdn-icons-png.flaticon.com/512/684/684908.png" },
      { type: "model", label: "3D人孔蓋", img: "./manhole_3dmodel/manhole.jpg", value: "./manhole_3dmodel/manhole.gltf" },
      { type: "model", label: "3D路燈", img: "./streetlamp_3dmodel/images.jpg", value: "./streetlamp_3dmodel/streetlamp.gltf" }
    ];

    // 建立圖示選擇 UI
    const iconChooser = document.getElementById("iconChooser");
    iconOptions.forEach((opt, i) => {
      const img = document.createElement("img");
      img.src = opt.img;
      img.width = 32;
      img.className = "icon-option" + (i === 0 ? " selected" : "");
      if (i === 0) selectedIcon = opt;
      img.onclick = () => {
        document.querySelectorAll(".icon-option").forEach(el => el.classList.remove("selected"));
        img.classList.add("selected");
        selectedIcon = opt;
      };
      iconChooser.appendChild(img);
    });

    // 檔案上傳
    document.getElementById("fileInput").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = evt => {
        try {
          pendingGeojson = JSON.parse(evt.target.result);
          pendingName = file.name.replace(/\.[^/.]+$/, "");
          alert(`檔案 "${pendingName}" 已暫存，可選圖示後匯入。`);
        } catch {
          alert("檔案格式錯誤");
        }
      };
      reader.readAsText(file);
    });

    // 確認匯入
    // document.getElementById("importBtn").onclick = async () => {
    //   if (!pendingGeojson) return alert("請先上傳資料集！");
    //   const dsId = `ds_${Date.now()}`;
    //   const dataSource = await Cesium.GeoJsonDataSource.load(pendingGeojson, { clampToGround: true });
    //   dataSource.entities.values.forEach(entity => {
    //     if (selectedIcon.type === "image") {
    //       entity.billboard = new Cesium.BillboardGraphics({
    //         image: selectedIcon.value,
    //         width: 32,
    //         height: 32,
    //         heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
    //       });
    //     } else {
    //       const position = Cesium.Property.getValueOrUndefined(entity.position, Cesium.JulianDate.now());
    //       const model = Cesium.Model.fromGltf({
    //         url: selectedIcon.value,
    //         modelMatrix: Cesium.Transforms.eastNorthUpToFixedFrame(position)
    //       });
    //       model.readyPromise.then(m => {
    //         const scale = 2.0 / (m.boundingSphere.radius * 2);
    //         model.scale = scale;
    //       });
    //       viewer.scene.primitives.add(model);
    //     }
    //   });

    //   datasets[dsId] = { name: pendingName, dataSource };
    //   updateDatasetsList();
    //   pendingGeojson = null;
    //   document.getElementById("fileInput").value = '';
    // };

    document.getElementById('importBtn').onclick = async function() {
        if (!pendingGeojson) { alert("請先上傳資料集！"); return; }
        if (!selectedIcon) { alert("請先選擇圖示！"); return; }
        const dsId = `ds_${Date.now()}`;
        try {
            const dataSource = await Cesium.GeoJsonDataSource.load(pendingGeojson, { clampToGround: true });
            dataSource.entities.values.forEach(entity => {
            if (selectedIcon.type === "image") {
                entity.model = undefined;
                entity.billboard = new Cesium.BillboardGraphics({
                image: selectedIcon.value,
                width: 32,
                height: 32,
                verticalOrigin: Cesium.VerticalOrigin.CENTER,
                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                });
            } else if (selectedIcon.type === "model") {
                entity.billboard = undefined;
                entity.model = new Cesium.ModelGraphics({
                uri: selectedIcon.value,
                scale: 1.0,                       // 可依模型調整
                minimumPixelSize: 32,
                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                runAnimations: false
                });
            }
            });
            datasets[dsId] = {
            id: dsId,
            name: pendingName,
            data: pendingGeojson,
            iconType: selectedIcon.type,
            iconValue: selectedIcon.value,
            dataSource: dataSource
            };
            updateDatasetsList();
            alert(`資料集 "${pendingName}" 已匯入，可點選顯示！`);
            pendingGeojson = null; pendingName = '';
            document.getElementById("fileInput").value = '';
        } catch(e) {
            alert("GeoJSON 載入失敗");
        }
    };

    // 更新清單
    function updateDatasetsList() {
      const list = document.getElementById("datasetsList");
      list.innerHTML = '';
      Object.keys(datasets).forEach(id => {
        const li = document.createElement("li");
        li.textContent = datasets[id].name;
        li.onclick = () => showDataset(id);
        const delBtn = document.createElement("button");
        delBtn.textContent = "刪除";
        delBtn.onclick = e => { e.stopPropagation(); removeDataset(id); };
        li.appendChild(delBtn);
        list.appendChild(li);
      });
    }

    // 顯示資料
    function showDataset(id) {
      if (currentDataSource) viewer.dataSources.remove(currentDataSource);
      currentDataSource = datasets[id].dataSource;
      viewer.dataSources.add(currentDataSource);
      viewer.flyTo(currentDataSource);
    }

    // 刪除單筆
    function removeDataset(id) {
      viewer.dataSources.remove(datasets[id].dataSource);
      delete datasets[id];
      updateDatasetsList();
    }

    // 清除所有
    document.getElementById("clearAllBtn").onclick = () => {
      if (confirm("確定清除所有資料？")) {
        Object.values(datasets).forEach(ds => viewer.dataSources.remove(ds.dataSource));
        datasets = {};
        updateDatasetsList();
      }
    };

    // Home 按鈕自訂
    viewer.homeButton.viewModel.command.beforeExecute.addEventListener(e => {
      e.cancel = true;
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 300000),
        orientation: { heading: 0, pitch: Cesium.Math.toRadians(-90), roll: 0 }
      });
    });
  </script>
</body>
</html>
