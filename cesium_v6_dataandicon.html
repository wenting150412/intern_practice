<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Cesium 載入資料及3d icon</title>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; overflow:hidden;}
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <!-- 控制面板 -->
  <div id="controlPanel" style="position:absolute;top:10px;left:10px;z-index:100;background:rgba(255,255,255,0.9);padding:10px;border-radius:5px;width:210px;font-size:14px;">
    <!-- 檔案上傳 -->
    <label for="RepairFileInput">上傳資料集</label>
    <input type="file" id="RepairFileInput" accept=".json,.geojson" style="width:100%;margin-bottom:5px;"/>
    <!-- 圖示選擇 -->
    <div id="iconChooser" style="margin-bottom:5px;">
      <strong>選擇圖示：</strong>
      <div style="display:flex;gap:4px;margin-top:4px;"></div>
    </div>
    <button id="confirmImportBtn" style="width:100%">確認匯入</button>
    <div>
      <strong>已匯入資料集：</strong>
      <ul id="datasetsList" style="padding-left:20px;"></ul>
    </div>
    <!-- 飛到資料按鈕 -->
    <button id="flyToBtn" style="margin-top:5px;width:100%;background-color:#17a2b8;color:white;border:none;padding:5px;border-radius:3px;cursor:pointer;">
      飛到資料位置
    </button>
    <!-- 清除所有資料按鈕 -->
    <button id="clearBtn" style="margin-top:5px;width:100%;background-color:#dc3545;color:white;border:none;padding:5px;border-radius:3px;cursor:pointer;">
      清除所有資料
    </button>
  </div>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNmIzMDE3Yy1mYWQ2LTQ4YTQtOWQ3Ny1lZjgwNTcxOTU5MTkiLCJpZCI6MzIyMjU0LCJpYXQiOjE3NTI3MjY4MjJ9.12vLgFNaTNa4AO8PYo3hByBcXUodMbnX_u--RM59ySg';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false,
      baseLayerPicker: false,
      timeline: false,
      baseLayer: Cesium.ImageryLayer.fromProviderAsync(
        Cesium.ArcGisMapServerImageryProvider.fromUrl("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer")
      )
    });
    viewer.scene.globe.depthTestAgainstTerrain = true;

    // 完全俯視台灣中央
    viewer.scene.postRender.addEventListener(function once() {
      viewer.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 350000),
        orientation: {
          heading: Cesium.Math.toRadians(0),
          pitch: Cesium.Math.toRadians(-90),
          roll: 0
        }
      });
      viewer.scene.postRender.removeEventListener(once);
    });

    // 電子地圖WMTS
    const emapWmtsLayer = viewer.imageryLayers.addImageryProvider(
      new Cesium.UrlTemplateImageryProvider({
        url: "https://wmts.nlsc.gov.tw/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}.png",
        tilingScheme: new Cesium.WebMercatorTilingScheme(),
        maximumLevel: 18
      })
    );
    emapWmtsLayer.show = true;

    // 狀態變數
    let pendingGeojson = null, pendingName = '';
    let datasets = {}; // 儲存多組資料
    let currentDataSource = null;
    let selectedIconType = "", selectedIconValue = "";

    // 圖示/模型選項 (建議模型路徑換成CDN，local要自備正確檔案路徑)
    const iconOptions = [
      {
        type: "image",
        label: "警示點",
        img: "https://cdn-icons-png.flaticon.com/512/3756/3756712.png",
        value: "https://cdn-icons-png.flaticon.com/512/3756/3756712.png"
      },
      {
        type: "image",
        label: "地點標記",
        img: "https://cdn-icons-png.flaticon.com/512/684/684908.png",
        value: "https://cdn-icons-png.flaticon.com/512/684/684908.png"
      },
      {
        type: "model",
        label: "3D人孔蓋",
        img: "./manhole_3dmodel/manhole.jpg",
        value: "./manhole_3dmodel/manhole.gltf",
        scale: 0.03 // 這個模型建議用 1.5 倍
      },
      {
        type: "model",
        label: "3D路燈",
        img: "./streetlamp_3dmodel/images.jpg",
        value: "./streetlamp_3dmodel/streetlamp.gltf",
        scale: 50 // 這個模型建議用 0.03 倍縮放
        // img: "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Lantern/glTF/Lantern.png",
        // value: "https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Lantern/glTF/Lantern.gltf"
      }
    ];

    // 建立圖示選擇器
    function buildIconChooser() {
      const container = document.querySelector("#iconChooser > div");
      container.innerHTML = "";
      iconOptions.forEach((opt, idx) => {
        const img = document.createElement("img");
        img.src = opt.img;
        img.width = 32;
        img.className = "icon-option";
        img.dataset.type = opt.type;
        img.dataset.value = opt.value;
        img.title = opt.label;
        img.style.cursor = "pointer";
        img.style.border = idx === 0 ? "2px solid #007BFF" : "2px solid transparent";
        img.onclick = function() {
          document.querySelectorAll(".icon-option").forEach(i => i.style.border = "2px solid transparent");
          img.style.border = "2px solid #007BFF";
          selectedIconType = opt.type;
          selectedIconValue = opt.value;
        };
        container.appendChild(img);
      });
      selectedIconType = iconOptions[0].type;
      selectedIconValue = iconOptions[0].value;
    }
    buildIconChooser();

    // 檔案上傳讀取
    document.getElementById("RepairFileInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          pendingGeojson = JSON.parse(e.target.result);
          pendingName = file.name.replace(/\.[^/.]+$/, "");
          alert('檔案 "' + pendingName + '" 已暫存，可選圖示後點確認匯入。');
        } catch {
          alert('檔案格式錯誤');
          pendingGeojson = null;
          pendingName = '';
        }
      };
      reader.readAsText(file);
    });

    // 確認匯入
    document.getElementById("confirmImportBtn").onclick = async function() {
      if (!pendingGeojson) { alert("請先上傳資料集！"); return; }
      if (!selectedIconValue) { alert("請先選擇圖示！"); return; }
      const dsId = `ds_${Date.now()}`;
      try {
        const dataSource = await Cesium.GeoJsonDataSource.load(pendingGeojson, { clampToGround: true });
        dataSource.entities.values.forEach(entity => {
          if (selectedIconType === "image") {
            entity.model = undefined;
            entity.billboard = new Cesium.BillboardGraphics({
              image: selectedIconValue,
              width: 32,
              height: 32,
              verticalOrigin: Cesium.VerticalOrigin.CENTER,
              heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
            });
          } else if (selectedIconType === "model") {
            const currentIcon = iconOptions.find(opt => opt.value === selectedIconValue);
            let targetScale = currentIcon && currentIcon.scale ? currentIcon.scale : 1.0;
            entity.billboard = undefined;
            entity.model = new Cesium.ModelGraphics({
              uri: selectedIconValue,
              scale: targetScale,
              minimumPixelSize: 1,
              heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
              runAnimations: false
            });
          }
        });
        datasets[dsId] = {
          id: dsId,
          name: pendingName,
          data: pendingGeojson,
          iconType: selectedIconType,
          iconValue: selectedIconValue,
          dataSource: dataSource
        };
        updateDatasetsList();
        alert('資料集 "' + pendingName + '" 已匯入，可點選顯示！');
        pendingGeojson = null; pendingName = '';
        document.getElementById("RepairFileInput").value = '';
      } catch(e) {
        alert('GeoJSON 載入失敗');
      }
    };

    // 更新資料集清單
    function updateDatasetsList() {
      const list = document.getElementById("datasetsList");
      list.innerHTML = '';
      for(const id in datasets) {
        const li = document.createElement('li');
        li.textContent = datasets[id].name;
        li.style.cursor = 'pointer';
        li.onclick = () => showDataset(id);
        const delBtn = document.createElement('button');
        delBtn.textContent = '刪除';
        delBtn.style.marginLeft = '10px';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          removeDataset(id);
        };
        li.appendChild(delBtn);
        list.appendChild(li);
      }
    }

    // 顯示資料集（聚焦）
    function showDataset(id) {
      if (currentDataSource) {
        viewer.dataSources.remove(currentDataSource);
      }
      currentDataSource = datasets[id].dataSource;
      viewer.dataSources.add(currentDataSource);
      // 改用 Cesium 官方推薦的 flyTo
      viewer.flyTo(currentDataSource, {
        duration: 2,
        offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90), 5000)
      });
    }

    // 刪除資料
    function removeDataset(id) {
      if (datasets[id]) {
        if (datasets[id].dataSource === currentDataSource) {
          viewer.dataSources.remove(currentDataSource);
          currentDataSource = null;
        }
        delete datasets[id];
        updateDatasetsList();
      }
    }

    document.getElementById('clearBtn').onclick = function() {
      if (confirm('確定清除所有資料？')) {
        Object.values(datasets).forEach(ds => viewer.dataSources.remove(ds.dataSource));
        datasets = {};
        pendingGeojson = null; pendingName = '';
        updateDatasetsList();
      }
    };

    // 飛到目前資料集
    document.getElementById("flyToBtn").onclick = function() {
      if (currentDataSource) {
        viewer.flyTo(currentDataSource, {
          duration: 2,
          offset: new Cesium.HeadingPitchRange(0, Cesium.Math.toRadians(-90), 5000)
        });
      } else {
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 300000),
          orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch: Cesium.Math.toRadians(-90),
            roll: 0
          }
        });
      }
    };

    // 點擊顯示描述
    viewer.cesiumWidget.screenSpaceEventHandler.setInputAction(function (click) {
      const picked = viewer.scene.pick(click.position);
      if (Cesium.defined(picked) && picked.id) {
        const entity = picked.id;
        if (entity.description) {
          viewer.selectedEntity = entity;
        }
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // 滑鼠移動顯示label，針對所有目前掛載 entities
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction((movement) => {
      let picked = viewer.scene.pick(movement.endPosition);
      // 依據目前所有的dataSource遍歷
      Object.values(datasets).forEach(ds => {
        ds.dataSource.entities.values.forEach((entity) => {
          if (entity.label) {
            entity.label.show = (picked && picked.id === entity);
          }
        });
      });
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);

    // Home鍵自訂
    viewer.homeButton.viewModel.command.beforeExecute.addEventListener(e => {
      e.cancel = true;
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 300000),
        orientation: {
          heading: Cesium.Math.toRadians(0),
          pitch: Cesium.Math.toRadians(-90),
          roll: 0
        }
      });
    });

    // 全域錯誤控制
    window.addEventListener('error', function(event) {
      console.error('全域錯誤:', event.error);
    });

  </script>
</body>
</html>