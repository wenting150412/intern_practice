<!-- <!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Cesium 切換 I3S 與底圖</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #toggleLayerBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="toggleLayerBtn">切換 I3S 圖層 + 電子地圖底圖</button>

  <script>
    // 替換成你的 Cesium token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNmIzMDE3Yy1mYWQ2LTQ4YTQtOWQ3Ny1lZjgwNTcxOTU5MTkiLCJpZCI6MzIyMjU0LCJpYXQiOjE3NTI3MjY4MjJ9.12vLgFNaTNa4AO8PYo3hByBcXUodMbnX_u--RM59ySg';

    // 初始化 Cesium Viewer
    var viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false,
      baseLayerPicker: false,
      timeline: false,
    });

    // 添加WMTS圖層
    viewer.imageryLayers.addImageryProvider(
      new Cesium.UrlTemplateImageryProvider({
        // 這邊是用內政部的通用電子地圖，可以去內政部國土測繪參考，如果你有放其他的底圖的話。
        url: "https://wmts.nlsc.gov.tw/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}.png",
        tilingScheme: new Cesium.WebMercatorTilingScheme(),
        maximumLevel: 18,
      })
    );

    // 初始化時創建圖例
    document.addEventListener('DOMContentLoaded', function() {
        createLegend();
    });

    // 加入 3D Tiles 建築物模型
    const buildingTileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
      url: "https://3dtiles.nlsc.gov.tw/building/tiles3d/1/tileset.json"
    }));

    // 初始視角：台中市
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(120.6839, 24.1871, 55000),
      orientation: {
        heading: Cesium.Math.toRadians(0),
        pitch: Cesium.Math.toRadians(-90),
        roll: 0
      }
    });

    // ✅ HomeButton 回台灣上空
    viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function (e) {
      e.cancel = true;
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(120.65, 24.15, 3000000),
        orientation: {
          heading: Cesium.Math.toRadians(0),
          pitch: Cesium.Math.toRadians(-90),
          roll: 0
        }
      });
    });

    // 匯入 3D Tiles 模型
    // const buildingTileset = viewer.scene.primitives.add(
    //   new Cesium.Cesium3DTileset({
    //     url: "https://3dtiles.nlsc.gov.tw/building/tiles3d/1/tileset.json"
    //   })
    // );

    // var tileset = viewer.scene.primitives.add(new Cesium.Cesium3DTileset({
    //     url: url, //数据路径
    //     maximumScreenSpaceError: 2, //最大的屏幕空间误差
    //     maximumNumberOfLoadedTiles: 1000, //最大加载瓦片个数
    //     modelMatrix: m //形状矩阵
    // }));

    // // 全域變數
    // let clickHandler = null; // 避免重複註冊事件監聽器

    // // 方法 1：使用 fetch 載入 JSON 檔案（需要 HTTP 伺服器）
    // function loadJSONFromServer() {
    //     fetch('Taichung_Welfare_Institution.json')
    //         .then(response => {
    //             if (!response.ok) {
    //                 throw new Error("載入失敗：" + response.statusText);
    //             }
    //             return response.json();
    //         })
    //         .then(data => {
    //             console.log("成功載入 JSON：", data);
    //             processWelfareData(data);
    //         })
    //         .catch(error => {
    //             console.error("載入 JSON 發生錯誤：", error);
    //             console.log("請確認檔案存在於正確路徑，或使用檔案上傳功能");
    //         });
    // }

    // // 添加事件監聽器到 HTML input 元素 (type="file")
    // document.getElementById('Taichung_Welfare_Institution').addEventListener('change', loadFiles, false);

    // // 座標轉換函數：TWD97 TM2 轉 WGS84
    // function convertTWD97ToWGS84(x, y) {
    //     // 這是一個簡化的轉換，實際使用時建議使用 proj4js 等專業庫
    //     // TWD97 TM2 參數
    //     const a = 6378137.0; // 長半軸
    //     const f = 1 / 298.257223563; // 扁率
    //     const k0 = 0.9999; // 比例因子
    //     const lon0 = 121 * Math.PI / 180; // 中央經線 (121°E)
    //     const lat0 = 0; // 虛擬原點緯度
    //     const dx = 250000; // 東偏移
    //     const dy = 0; // 北偏移
        
    //     // 簡化轉換 (僅適用於台灣地區)
    //     const longitude = lon0 + (x - dx) / (a * k0) * 180 / Math.PI;
    //     const latitude = (y - dy) / (a * k0) * 180 / Math.PI;
        
    //     return {
    //         longitude: longitude,
    //         latitude: latitude
    //     };
    // }

    // // 根據機構類型設定顏色
    // function getInstitutionColor(institutionType) {
    //     const colorMap = {
    //         '安養': Cesium.Color.BLUE,
    //         '養護': Cesium.Color.GREEN,
    //         '安養/養護': Cesium.Color.PURPLE,
    //         '長照': Cesium.Color.ORANGE,
    //         '日照': Cesium.Color.YELLOW,
    //         '失智': Cesium.Color.RED
    //     };
        
    //     return colorMap[institutionType] || Cesium.Color.GRAY;
    // }

    // // 設定點擊事件處理器
    // function setupClickHandler() {
    //     viewer.cesiumWidget.screenSpaceEventHandler.setInputAction(function(event) {
    //         let pickedObject = viewer.scene.pick(event.position);
            
    //         if (Cesium.defined(pickedObject) && pickedObject.id && pickedObject.id.properties) {
    //             let entity = pickedObject.id;
    //             let props = entity.properties;
                
    //             // 建立資訊視窗內容
    //             let infoContent = `
    //                 <div style="max-width: 300px; font-family: Arial, sans-serif;">
    //                     <h3 style="margin: 0 0 10px 0; color: #333;">${props.辦理單位._value}</h3>
    //                     <hr style="margin: 10px 0;">
                        
    //                     <p><strong>地址：</strong>${props.地址._value}</p>
    //                     <p><strong>行政區：</strong>${props.行政區._value}</p>
    //                     <p><strong>連絡電話：</strong>${props.連絡電話._value}</p>
    //                     <p><strong>負責人：</strong>${props.負責人._value}</p>
                        
    //                     <hr style="margin: 10px 0;">
    //                     <h4 style="margin: 5px 0; color: #666;">收容資訊</h4>
    //                     <p><strong>核定收容人數：</strong>${props.核定收容人數._value} 人</p>
    //                     <p><strong>安養：</strong>${props.收容對象_安養._value} 人</p>
    //                     <p><strong>養護：</strong>${props.收容對象_養護._value} 人</p>
    //                     <p><strong>長照：</strong>${props.收容對象_長照._value} 人</p>
    //                     <p><strong>日照：</strong>${props.收容對象_日照._value} 人</p>
    //                     <p><strong>失智：</strong>${props.收容對象_失智._value} 人</p>
                        
    //                     <hr style="margin: 10px 0;">
    //                     <p><strong>機構類型：</strong>${props.機構類型._value}</p>
    //                     <p><strong>評鑑等級：</strong>${props.評鑑等級._value}</p>
    //                     <p><strong>成立日期：</strong>${props.成立日期._value}</p>
    //                     <p><strong>服務時間：</strong>${props.服務時間._value}</p>
                        
    //                     ${props.簡介._value ? '<hr style="margin: 10px 0;"><p><strong>簡介：</strong>' + props.簡介._value + '</p>' : ''}
    //                     ${props.相關網址._value ? '<p><strong>網址：</strong><a href="' + props.相關網址._value + '" target="_blank">' + props.相關網址._value + '</a></p>' : ''}
    //                 </div>
    //             `;
                
    //             // 顯示資訊視窗
    //             entity.description = infoContent;
    //             viewer.selectedEntity = entity;
    //         }
    //     }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
    // }

    // 新增圖例顯示功能
    function createLegend() {
        let legend = document.createElement('div');
        legend.id = 'legend';
        legend.style.cssText = `
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(42, 42, 42, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 12px;
            z-index: 1000;
        `;
        
        legend.innerHTML = `
            <h4 style="margin: 0 0 10px 0;">福利機構圖例</h4>
            <div><span style="color: blue;">●</span> 安養機構</div>
            <div><span style="color: green;">●</span> 養護機構</div>
            <div><span style="color: purple;">●</span> 安養/養護機構</div>
            <div><span style="color: orange;">●</span> 長照機構</div>
            <div><span style="color: yellow;">●</span> 日照機構</div>
            <div><span style="color: red;">●</span> 失智機構</div>
        `;
        
        document.body.appendChild(legend);
    }


    // 圖層切換邏輯
    let isSwitched = false;
    let originalBaseLayer = viewer.imageryLayers.get(0); // 初始底圖
    let i3sLayer = null;

    document.getElementById("toggleLayerBtn").addEventListener("click", async function () {
      if (!isSwitched) {
        // 先移除原本底圖
        viewer.imageryLayers.remove(originalBaseLayer, false);

        // 載入台灣 e-Map 電子地圖
        const emapLayer = new Cesium.WebMapTileServiceImageryProvider({
          url: "https://cors-anywhere.herokuapp.com/https://wmts.nlsc.gov.tw/wmts",
          layer: "EMAP",
          style: "default",
          format: "image/png",
          tileMatrixSetID: "GoogleMapsCompatible",
          tilingScheme: new Cesium.WebMercatorTilingScheme(),
          maximumLevel: 19,
          tileMatrixLabels: Array.from({ length: 20 }, (_, i) => `${i}`),
          credit: "內政部國土測繪中心"
        });


        originalBaseLayer = viewer.imageryLayers.addImageryProvider(emapLayer);

        // ✅ 載入 I3S 圖層（台中市建物）
        i3sLayer = new Cesium.I3SDataProvider({
          url: "https://i3s.nlsc.gov.tw/building/i3s/SceneServer/layers/1"
        });
        viewer.scene.primitives.add(i3sLayer);

        // ✅ 按鈕文字改變
        this.textContent = "還原 Cesium 底圖 + 移除 I3S";
        isSwitched = true;

      } else {
        // ✅ 移除電子地圖 → 改回 Cesium 原本底圖
      viewer.imageryLayers.remove(originalBaseLayer, false);

      const defaultLayer = new Cesium.TileMapServiceImageryProvider({
        url: Cesium.buildModuleUrl('Assets/Textures/NaturalEarthII')
      });
      originalBaseLayer = viewer.imageryLayers.addImageryProvider(defaultLayer);

        // ✅ 移除 I3S 圖層
        if (i3sLayer) {
          viewer.scene.primitives.remove(i3sLayer);
          i3sLayer = null;  
        }

        // ✅ 按鈕文字改回原本
        this.textContent = "切換 I3S 圖層 + 電子地圖底圖";
        isSwitched = false;
      }
    });
  </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Cesium 切換 I3S 與底圖 + 3D Tiles</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    #toggleLayerBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    #toggle3DTilesBtn {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 100;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <button id="toggleLayerBtn">切換 I3S 圖層 + 電子地圖底圖</button>
  <button id="toggle3DTilesBtn">切換 3D Tiles 建築物</button>

  <script>
    // 替換成你的 Cesium token
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNmIzMDE3Yy1mYWQ2LTQ4YTQtOWQ3Ny1lZjgwNTcxOTU5MTkiLCJpZCI6MzIyMjU0LCJpYXQiOjE3NTI3MjY4MjJ9.12vLgFNaTNa4AO8PYo3hByBcXUodMbnX_u--RM59ySg';

    // 初始化 Cesium Viewer
    var viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false,
      baseLayerPicker: false,
      timeline: false,
    });

    // 添加WMTS圖層
    viewer.imageryLayers.addImageryProvider(
      new Cesium.UrlTemplateImageryProvider({
        // 這邊是用內政部的通用電子地圖，可以去內政部國土測繪參考，如果你有放其他的底圖的話。
        url: "https://wmts.nlsc.gov.tw/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}.png",
        tilingScheme: new Cesium.WebMercatorTilingScheme(),
        maximumLevel: 18,
      })
    );

    // 全域變數存儲 3D Tiles
    let buildingTileset = null;
    let is3DTilesVisible = false;

    // 加載 3D Tiles 建築物模型（修正版本）
    function load3DTiles() {
      try {
        buildingTileset = viewer.scene.primitives.add(
          new Cesium.Cesium3DTileset({
            url: "https://3dtiles.nlsc.gov.tw/building/tiles3d/1/tileset.json"
          })
        );

        // 當 tileset 準備就緒時執行
        buildingTileset.readyPromise.then(function(tileset) {
          console.log('3D Tiles 載入成功');
          
          // 可以設定一些樣式選項
          tileset.style = new Cesium.Cesium3DTileStyle({
            color: {
              conditions: [
                ["${Height} >= 20", "color('lightblue')"],
                ["${Height} >= 10", "color('yellow')"],
                ["true", "color('white')"]
              ]
            }
          });

          // 飛到建築物位置（台中市區）
          viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(120.6839, 24.1871, 1000),
            orientation: {
              heading: Cesium.Math.toRadians(0),
              pitch: Cesium.Math.toRadians(-45),
              roll: 0
            }
          });
        }).catch(function(error) {
          console.error('3D Tiles 載入失敗:', error);
        });

        is3DTilesVisible = true;
      } catch (error) {
        console.error('建立 3D Tiles 時發生錯誤:', error);
      }
    }

    // 切換 3D Tiles 顯示/隱藏
    function toggle3DTiles() {
      if (buildingTileset) {
        buildingTileset.show = !buildingTileset.show;
        is3DTilesVisible = buildingTileset.show;
      } else {
        load3DTiles();
      }
      
      // 更新按鈕文字
      const btn = document.getElementById('toggle3DTilesBtn');
      btn.textContent = is3DTilesVisible ? '隱藏 3D Tiles 建築物' : '顯示 3D Tiles 建築物';
    }

    // 初始化時創建圖例
    document.addEventListener('DOMContentLoaded', function() {
        // 如果有 createLegend 函數的話
        if (typeof createLegend === 'function') {
            createLegend();
        }
        
        // 綁定 3D Tiles 切換按鈕事件
        document.getElementById('toggle3DTilesBtn').addEventListener('click', toggle3DTiles);
        
        // 自動載入 3D Tiles（可選）
        // load3DTiles();
    });

    // 初始視角：台中市
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(120.6839, 24.1871, 55000),
      orientation: {
        heading: Cesium.Math.toRadians(0),
        pitch: Cesium.Math.toRadians(-90),
        roll: 0
      }
    });

    // ✅ HomeButton 回台灣上空
    viewer.homeButton.viewModel.command.beforeExecute.addEventListener(function (e) {
      e.cancel = true;
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(120.65, 24.15, 3000000),
        orientation: {
          heading: Cesium.Math.toRadians(0),
          pitch: Cesium.Math.toRadians(-90),
          roll: 0
        }
      });
    });
  </script>
</body>
</html>