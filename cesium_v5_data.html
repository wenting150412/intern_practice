<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>Cesium 多縣市 3D Tiles 選擇</title>
  <script src="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/cesium@1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet" />
  <!-- <style>
    html, body, #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    /* #toggleLayerBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    } */
    /* #toggleRepairBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: white;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
    } */
  </style> -->
</head>

<body>
  <div id="cesiumContainer"></div>

  <!-- 左上角控制面板 -->
  <div id="controlPanel" style="
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 100;
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 5px;
      width: 200px;
      font-size: 14px;
  ">
  <!-- 檔案上傳 -->
  <label for="RepairFileInput">上傳資料集</label>
  <input type="file" id="RepairFileInput" accept=".json,.geojson" style="width: 100%; margin-bottom: 5px;" />

  <!-- 圖示選擇 -->
  <div id="iconChooser" style="margin-bottom: 5px;">
    <strong>選擇圖示：</strong>
    <div style="display: flex; gap: 4px; margin-top: 4px;">
      <img src="https://cdn-icons-png.flaticon.com/512/3756/3756712.png" 
            class="icon-option" data-url="https://cdn-icons-png.flaticon.com/512/3756/3756712.png" width="24" />
      <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" 
            class="icon-option" data-url="https://cdn-icons-png.flaticon.com/512/684/684908.png" width="24" />
      <img src="https://cdn-icons-png.flaticon.com/512/1483/1483336.png" 
            class="icon-option" data-url="https://cdn-icons-png.flaticon.com/512/1483/1483336.png" width="24" />
    </div>
  </div>

  <!-- 確認匯入 -->
 <button id="confirmImportBtn" style="width:100%">確認匯入</button>
  <!-- 下拉選單 -->
  <div>
    <strong>已匯入資料集：</strong>
    <ul id="datasetsList" style="padding-left:20px;"></ul>
  </div>

  <!-- 預設資料上傳 -->
  <!-- <label for"="DefaultGeojsonInput">選擇預設資料</label>
  <input type=file" id="DefaultGeojsonInput" accept=".json,.geojson" style="width: 100%;" /> -->
  </div>

  <!-- 清除所有資料 -->
  <button id="clearBtn" style="margin-top: 5px; width: 100%; background-color: #dc3545; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer;">
  清除所有資料
  </button>

  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIyNmIzMDE3Yy1mYWQ2LTQ4YTQtOWQ3Ny1lZjgwNTcxOTU5MTkiLCJpZCI6MzIyMjU0LCJpYXQiOjE3NTI3MjY4MjJ9.12vLgFNaTNa4AO8PYo3hByBcXUodMbnX_u--RM59ySg';

    const viewer = new Cesium.Viewer('cesiumContainer', {
      terrain: Cesium.Terrain.fromWorldTerrain(),
      animation: false,
      baseLayerPicker: false,
      timeline: false,
      baseLayer: Cesium.ImageryLayer.fromProviderAsync(
        Cesium.ArcGisMapServerImageryProvider.fromUrl("https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer")
      )
    });

    viewer.scene.globe.depthTestAgainstTerrain = true;

    // 電子地圖圖層 (內政部 WMTS)
    const emapWmtsLayer = viewer.imageryLayers.addImageryProvider(
      new Cesium.UrlTemplateImageryProvider({
        url: "https://wmts.nlsc.gov.tw/wmts/EMAP5/default/EPSG:3857/{z}/{y}/{x}.png",
        tilingScheme: new Cesium.WebMercatorTilingScheme(),
        maximumLevel: 18
      })
    );
    emapWmtsLayer.show = true;

    let pendingGeojson = null;
    let pendingName = '';
    let datasets = {}; // 存放 {id, name, data, iconUrl, dataSource}
    let geojsonDataSource = null;
    let customRepairFiles = {};
    // let RepairEntities = [];
    let currentDataSource = null; // 目前顯示中的Cesium.DataSource
    let selectedIconUrl = "https://cdn-icons-png.flaticon.com/512/3756/3756712.png"; // 預設圖示

    // 1. 處理 icon 選擇
    document.querySelectorAll(".icon-option").forEach(img => {
      img.onclick = function() {
        selectedIconUrl = img.dataset.url;
        document.querySelectorAll(".icon-option").forEach(i => i.style.border = "2px solid transparent");
        img.style.border = "2px solid #007BFF";
      }
    });
    // 預設選第一個圖示
    document.querySelector(".icon-option").click();

    // 2. 處理檔案上傳（只讀進 pending，不進資料集）
    document.getElementById("RepairFileInput").addEventListener("change", function(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          pendingGeojson = JSON.parse(e.target.result);
          pendingName = file.name.replace(/\.[^/.]+$/, "");
          alert('檔案 "' + pendingName + '" 已暫存，可選圖示後點確認匯入。');
        } catch {
          alert('檔案格式錯誤');
          pendingGeojson = null;
          pendingName = '';
        }
      };
      reader.readAsText(file);
    });

    // 3. 點擊確認匯入，兩者都選才執行
    document.getElementById("confirmImportBtn").onclick = async function() {
      if (!pendingGeojson) {
        alert("請先上傳資料集！");
        return;
      }
      if (!selectedIconUrl) {
        alert("請先選擇圖示！");
        return;
      }
      const dsId = `ds_${Date.now()}`;
      try {
        const dataSource = await Cesium.GeoJsonDataSource.load(pendingGeojson, { clampToGround: true });
        // 設定圖示
        dataSource.entities.values.forEach(entity => {
          entity.billboard = new Cesium.BillboardGraphics({
            image: selectedIconUrl,
            width: 32,
            height: 32,
            verticalOrigin: Cesium.VerticalOrigin.CENTER,
            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
          });
        });
        datasets[dsId] = {
          id: dsId,
          name: pendingName,
          data: pendingGeojson,
          iconUrl: selectedIconUrl,
          dataSource: dataSource
        };
        updateDatasetsList();
        alert('資料集 "' + pendingName + '" 已匯入，可點選顯示！');
        // 清除暫存，避免連續誤加
        pendingGeojson = null; pendingName = '';
        document.getElementById("RepairFileInput").value = '';
      } catch(e) {
        alert('GeoJSON 載入失敗');
      }
    };

    // 4. 資料集清單功能/動態切換
    function updateDatasetsList() {
      const list = document.getElementById("datasetsList");
      list.innerHTML = '';
      for(const id in datasets) {
        const li = document.createElement('li');
        li.textContent = datasets[id].name;
        li.style.cursor = 'pointer';
        li.onclick = () => showDataset(id);
        const delBtn = document.createElement('button');
        delBtn.textContent = '刪除';
        delBtn.style.marginLeft = '10px';
        delBtn.onclick = (e) => {
          e.stopPropagation();
          removeDataset(id);
        };
        li.appendChild(delBtn);
        list.appendChild(li);
      }
    }

    function showDataset(id) {
      // 1. 清掉 map 上（如果有）的資料集
      if (currentDataSource) {
        viewer.dataSources.remove(currentDataSource);
      }
      // 2. 把這一筆 dataSource 新增進 map
      currentDataSource = datasets[id].dataSource;
      viewer.dataSources.add(currentDataSource);

      // 3. 鏡頭飛到該資料範圍
      viewer.flyTo(currentDataSource, {
        duration: 2,  // 飛行時間 (秒)
        offset: new Cesium.HeadingPitchRange(
          0, 
          Cesium.Math.toRadians(-90), 
          5000 // 距離地面高度
        )
      })
    }

    // function removeDataset(id) {
    //   if(currentDatasetId === id) {
    //     viewer.dataSources.remove(datasets[id].dataSource);
    //     currentDatasetId = null;
    //   }
    //   delete datasets[id];
    //   updateDatasetsList();
    // }

    function removeDataset(id) {
      if (datasets[id]) {
        if (datasets[id].dataSource === currentDataSource) {
          viewer.dataSources.remove(currentDataSource);
          currentDataSource = null;
        }
        delete datasets[id];
        updateDatasetsList();
      }
    }

    // 5. 清除所有
    document.getElementById('clearBtn').onclick = function() {
      if (confirm('確定清除所有資料？')) {
        Object.values(datasets).forEach(ds => viewer.dataSources.remove(ds.dataSource));
        datasets = {};
        pendingGeojson = null; pendingName = '';
        currentDatasetId = null;
        updateDatasetsList();
      }
    };

    // 初始化：載入記憶體中的資料
    loadStoredData();

    // 地圖點擊事件處理
    viewer.cesiumWidget.screenSpaceEventHandler.setInputAction(function (click) {
      const picked = viewer.scene.pick(click.position);
      if (Cesium.defined(picked) && picked.id) {
        const entity = picked.id;
        if (entity.description) {
          // 顯示詳細資訊視窗
          viewer.selectedEntity = entity;
        }
      }
    }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

    // 清除資料功能
    function clearAllData() {
    // 1. 移除 RepairData 點位與圖層
    removeRepairData();

    // 4. 清除 RepairSelect 下拉選單的自訂選項
    const select = document.getElementById("RepairSelect");
    const options = select.querySelectorAll("option");
    options.forEach(option => {
      if (option.value !== "" && option.value !== "default") {
        option.remove();
      }
    });

    // 5. 清除記憶體資料
    Object.keys(customRepairFiles).forEach(key => delete customRepairFiles[key]);
    if (window.storedRepairData) {
      Object.keys(window.storedRepairData).forEach(key => delete window.storedRepairData[key]);
    }

    // 6. 重置下拉選單選擇
    select.value = "";

    console.log(" 所有資料已清除，地圖回復初始化狀態");
  }

    // 清除按鈕設定
    document.getElementById('clearBtn').addEventListener('click', function() {
      if (confirm('確定要清除所有自訂資料嗎？')) {
        clearAllData();
        alert('已清除所有資料！');
      }
    });

    document.getElementById("RepairDropdownPanel").appendChild(clearBtn);

    // 匯出當前資料功能
    function exportCurrentData() {
      const selectedValue = document.getElementById("RepairSelect").value;
      
      if (!selectedValue || selectedValue === "") {
        alert("請先選擇資料集！");
        return;
      }

      let dataToExport;
      let fileName;

      if (selectedValue === "default") {
        // 如果需要匯出預設資料，這裡可以添加邏輯
        alert("預設資料集無法匯出！");
        return;
      } else if (customRepairFiles[selectedValue]) {
        dataToExport = customRepairFiles[selectedValue].data;
        fileName = `${customRepairFiles[selectedValue].name}_export.json`;
      } else {
        alert("找不到選擇的資料集！");
        return;
      }

      // 創建下載連結
      const dataStr = JSON.stringify(dataToExport, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', fileName);
      linkElement.click();
    }

    // 添加匯出按鈕
    const exportBtn = document.createElement('button');
    exportBtn.textContent = '匯出當前資料';
    exportBtn.style.cssText = 'margin-top: 5px; width: 100%; background-color: #28a745; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer;';
    exportBtn.addEventListener('click', exportCurrentData);
    document.getElementById("RepairDropdownPanel").appendChild(exportBtn);

    // // 統計資訊顯示
    // function updateStatistics() {
    //   const totalCustomFiles = Object.keys(customRepairFiles).length;
    //   const totalEntities = RepairEntities.length;
    //   const totalDataSources = viewer.dataSources.length;
      
    //   // 更新或創建統計資訊顯示元素
    //   let statsDiv = document.getElementById('statsInfo');
    //   if (!statsDiv) {
    //     statsDiv = document.createElement('div');
    //     statsDiv.id = 'statsInfo';
    //     statsDiv.style.cssText = 'margin-top: 10px; font-size: 12px; color: #666; border-top: 1px solid #ccc; padding-top: 5px;';
    //     document.getElementById("RepairDropdownPanel").appendChild(statsDiv);
    //   }
      
    //   statsDiv.innerHTML = `
    //     <div>自訂檔案：${totalCustomFiles} 個</div>
    //     <div>實體數量：${totalEntities} 個</div>
    //     <div>資料源：${totalDataSources} 個</div>
    //   `;
    // }

    // 定期更新統計資訊
    setInterval(updateStatistics, 2000);

    // 視角控制優化
    function flyToData() {
      const selectedValue = document.getElementById("RepairSelect").value;
      
      if (selectedValue && customRepairFiles[selectedValue] && customRepairFiles[selectedValue].dataSource) {
        viewer.flyTo(customRepairFiles[selectedValue].dataSource);
      } else if (RepairEntities.length > 0) {
        // 飛到所有實體的包圍盒
        viewer.flyTo(viewer.entities);
      } else {
        // 回到台灣視角
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(120.65, 24.15, 1000000),
          orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch: Cesium.Math.toRadians(-90),
            roll: 0
          }
        });
      }
    }

    // 添加飛到資料按鈕
    const flyToBtn = document.createElement('button');
    flyToBtn.textContent = '飛到資料位置';
    flyToBtn.style.cssText = 'margin-top: 5px; width: 100%; background-color: #17a2b8; color: white; border: none; padding: 5px; border-radius: 3px; cursor: pointer;';
    flyToBtn.addEventListener('click', flyToData);
    document.getElementById("RepairDropdownPanel").appendChild(flyToBtn);

    // 鍵盤快捷鍵
    document.addEventListener('keydown', function(event) {
      // Ctrl + H: 回到台灣視角
      if (event.ctrlKey && event.key === 'h') {
        event.preventDefault();
        viewer.camera.flyTo({
          destination: Cesium.Cartesian3.fromDegrees(120.65, 24.15, 1000000),
          orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch: Cesium.Math.toRadians(-90),
            roll: 0
          }
        });
      }
      
      // Ctrl + C: 清除所有資料
      if (event.ctrlKey && event.key === 'c') {
        event.preventDefault();
        if (confirm('確定要清除所有自訂資料嗎？')) {
          clearAllData();
        }
      }
      // Ctrl + F: 飛到資料位置
      if (event.ctrlKey && event.key === 'f') {
        event.preventDefault();
        flyToData();
            }
        });

    // 錯誤處理和日誌記錄
    window.addEventListener('error', function(event) {
      console.error('全域錯誤:', event.error);
    });

    // 顯示載入進度
    function showLoadingProgress(message) {
      let progressDiv = document.getElementById('loadingProgress');
      if (!progressDiv) {
        progressDiv = document.createElement('div');
        progressDiv.id = 'loadingProgress';
        progressDiv.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: rgba(0,0,0,0.8);
          color: white;
          padding: 20px;
          border-radius: 5px;
          z-index: 1000;
          font-size: 16px;
        `;
        document.body.appendChild(progressDiv);
      }
      progressDiv.textContent = message;
      progressDiv.style.display = 'block';
    }

    function hideLoadingProgress() {
      const progressDiv = document.getElementById('loadingProgress');
      if (progressDiv) {
        progressDiv.style.display = 'none';
      }
    }

    // 初始化完成提示
    console.log('Cesium 維修資料系統初始化完成！');
    console.log('快捷鍵：');
    console.log('Ctrl + H: 回到台灣視角');
    console.log('Ctrl + C: 清除所有資料');
    console.log('Ctrl + F: 飛到資料位置');

    // 滑鼠移動顯示 label
    const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
    handler.setInputAction((movement) => {
      const picked = viewer.scene.pick(movement.endPosition);
      viewer.entities.values.forEach((entity) => {
        if (entity.label) {
          entity.label.show = (picked && picked.id === entity);
        }
      });
    }, Cesium.ScreenSpaceEventType.MOUSE_MOVE);
    // 初始相機位置：台灣
    viewer.camera.setView({
      destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 300000),
      orientation: {
        heading: Cesium.Math.toRadians(0),
        pitch: Cesium.Math.toRadians(-90),
        roll: 0
      }
    });

    // Home 鍵自訂
    viewer.homeButton.viewModel.command.beforeExecute.addEventListener(e => {
      e.cancel = true;
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(120.979, 23.755, 300000),
        orientation: {
          heading: Cesium.Math.toRadians(0),
          pitch: Cesium.Math.toRadians(-90),
          roll: 0
        }
      });
    });
  </script>
</body>
</html>